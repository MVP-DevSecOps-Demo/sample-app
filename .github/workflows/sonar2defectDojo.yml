name: SonarCloud Scan and Upload to DefectDojo

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  sonarcloud:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: SonarCloud Scan
        uses: sonarsource/sonarqube-scan-action@v2
        with:
          args: >
            -Dproject.settings=sonar-project.properties
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: "https://sonarcloud.io"

      - name: Check SonarCloud Quality Gate
        uses: sonarsource/sonarqube-quality-gate-action@v1
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: "https://sonarcloud.io"

      - name: Download SonarCloud issues
        run: |
          echo "Downloading SonarCloud issues..."
          curl -s -u "${{ secrets.SONAR_TOKEN }}:" \
            "https://sonarcloud.io/api/issues/search?componentKeys=MVP-DevSecOps-Demo_sample-app&types=VULNERABILITY&ps=500" \
            -o sonar_issues.json

      - name: Upload SonarCloud results to DefectDojo
        run: |
          echo "Uploading SonarCloud results to DefectDojo..."
          curl -X POST "${{ vars.DOJO_URL }}/api/v2/import-scan/" \
            -H "Authorization: Token ${{ vars.DOJO_API_KEY }}" \
            -F "scan_type=SonarQube Scan" \
            -F "file=@sonar_issues.json" \
            -F "engagement=${{ vars.DOJO_ENGAGEMENT_ID }}" \
            -F "active=true" \
            -F "verified=false"
